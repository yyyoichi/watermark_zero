# マークの生成方法について

Watermark Zero API（以降、`W-ZeroAPI`）では、ユーザから入力される文字列（**ソース**）から、バイト列（[]byte）の**マーク**を生成する手順について、広くアルゴリズムを公開して運用する。

## 概要

W-ZeroAPIはソースから**非可逆的変換によりマークを生成**する。つまりソースは画像に直接埋め込まない。
ソースは外部リソースへ組織ごとに保存され、タイムスタンプとノンスによって特定される構成となっている。
マークは下のような**664b (83B)**の固定長構成となっている。

| 名称 | 長さ | 目的 | 詳細 |
| :-- | --: | :--| :-- |
| バージョン | 1B | マークの構成管理のため |  |
| タイムスタンプ | 6B | マーク生成日時登録のため | Unixミリ秒 |
| ノンス | 2B | 外部リソースへのソース特定のため | 乱数 |
| 組織コード | 2B | 組織識別のため | 通常4桁のHexで表現される組織ごとに固有な値 |
| ハッシュ | 8B | ソース保存のため | 日時、ソースから決定論的に導かれるHMAC-SHA256ハッシュ値の先頭8B |
| 署名 | 64B | マークの改ざん防止のため | 署名以下のEd25519 |


### 秘密値

マーク作成に必要な秘密値（シークレット）は以下の通り。

| 名称 | 長さ | 単位 | 対象 | 詳細 |
| :-- | --: | :--| :-- | :-- |
| マスタキー | 32B | 組織 | ハッシュ、署名 | HKDFの導入鍵でHMACペッパーとEd25519シード作成 |
| システムソルト | 32B | システム | HKDF | HKDFでの鍵生成時のソルト |

## 構成詳細

### バージョン

本構成のバージョンは `0x01` となる。

### タイムスタンプ

Unixミリ秒を6Bで表現した整数。

W-ZeroAPIでは1秒間に10数以上の画像を処理し悲観的に見ても、組織あたり1ミリ秒あたり0.1枚（100/1sec）生成する。
トラフィックの集中や並列処理環境を考慮すると、マークごとのミリ秒の衝突は排除しきれない。

この衝突は、外部リソースへのソース特定ができないことを意味するため、次のノンスによって、一意性を確保する。

### ノンス

2Bの乱数。
タイムスタンプとノンスをキーに、ソースの外部問い合わせを実行する。

### 組織コード

2Bの16進数。`0x0a1b`など。
組織ごとにランダムに決定する。

### ハッシュ

ハッシュは、ソースをHMAC-SHA256を用いて導かれたハッシュ値の先頭8B。HMACペッパー（秘密鍵）は、組織別のマスタキーを導入鍵にHKDF-SHA256によって毎時生成される。

#### HKDFによるHMACペッパー生成

鍵の構成は以下に示すとおり。

| パラメータ | 値 | 詳細 |
| -- | -- | -- |
| IKM | マスタキー | 組織別に固有な導入鍵 |
| Salt | システムソルト | 秘匿情報 |
| Info | 生成時刻 + 'W-ZeroAPI-HMAC-Key-V1' | マークの生成時刻（YYYYMMddHH）とHMACドメインの連結 |


### 署名

署名はそれ以前の19Bメッセージ全体をEd25519で署名した64B。シード（秘密鍵）は、組織別のマスタキーを導入鍵にHKDF-SHA256によって毎時生成される。

#### HKDFによる署名シード生成

鍵の構成は以下に示すとおり。

| パラメータ | 値 | 詳細 |
| -- | -- | -- |
| IKM | マスタキー | 組織別に固有な導入鍵 |
| Salt | システムソルト | 秘匿情報 |
| Info | 生成時刻 + 'W-ZeroAPI-Ed25519-Seed-V1' | マークの生成時刻（YYYYMMddHH）とEd25519ドメインの連結 |

