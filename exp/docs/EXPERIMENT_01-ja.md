# 透かし品質評価ツール

## 概要

このツールは、様々なパラメータ組み合わせにおける透かしの埋め込み・抽出の精度を評価します。

## 実行方法

```bash
go run cmd/quality/main.go -n <画像数>
```

オプション:
- `-n`: テストする画像の枚数（デフォルト: 10）

## テストパラメータ

### 画像サイズ（5種類）
- 1920x1080 (FHD)
- 1280x720 (HD)
- 854x480 (480p)
- 640x360 (360p)
- 426x240 (240p)

### ブロック形状（5種類）
- 4x4
- 4x6
- 6x6
- 6x8
- 8x8

### D1/D2パラメータ（4種類）
- 36x20
- 30x17
- 25x14
- 20x11

**合計**: 1画像あたり 5 × 5 × 4 = 100 テストケース

## 重要な指標: EmbedCount

**EmbedCount** = TotalBlocks / MarkLength

この値は、1ビットの透かし情報が何回重複して埋め込まれるかを表します。

## 性能テスト

### 実験1: EmbedCountの閾値調査

**目的**: EmbedCountと抽出精度の関係を調査し、おおまかな閾値を特定する

#### テスト条件
- JPEG圧縮: Quality 100
- 透かしデータ: "TEST_MARK" (wzeromark エンコード = 664bit)
- 画像数: 1枚
- テストケース: 100 (5サイズ × 5ブロック形状 × 4 D1/D2)

#### 結果

**成功率: 77%** ([詳細ログ: result_01.txt](result_01.txt))

1画像（100テストケース）での評価により、透かしの安定性（抽出精度）はEmbedCountに強く依存することが確認されました。

透かしの安定性（抽出精度）は、EmbedCountに強く依存することが確認されました。

**検証された仮説**:
- **EmbedCount ≧ 10**: ほぼ100%の精度で安定して抽出可能
  - FHD (1920x1080): すべてのパラメータで成功 (EmbedCount: 48.80～195.18)
  - HD (1280x720): すべてのパラメータで成功 (EmbedCount: 21.69～86.75)
  
- **EmbedCount < 10**: 精度が顕著に低下
  - 854x480 + 8x8 + 20x11: EmbedCount=9.58 → 99.8% (境界線)
  - 640x360 + 8x8: EmbedCount=5.42 → 99.4%～100%（不安定）
  - 426x240: EmbedCount < 10 のほとんどで失敗（95%～100%）

**重要な知見**:
1. **EmbedCount=10が明確な閾値**: この値を下回ると精度が急激に低下
2. **D1D2の影響は限定的**: EmbedCount > 10 の範囲では、D1D2が20x11でも安定
3. **小さい画像では大きなD1D2が必須**: 426x240では最大のD1D2(36x20)でも不安定

**おおまかな閾値**: EmbedCount ≈ 10

### 実験2: 詳細な閾値の特定（予定）

**目的**: より多くの画像とより細かいパラメータでEmbedCountの正確な閾値を特定する

#### 計画

**パラメータ**:
- 画像数: 10～50枚（統計的に有意な結果を得るため）
- 画像サイズ: EmbedCount 5～15 の範囲をカバーする解像度を集中的にテスト
  - 例: 800x450, 640x360, 512x288, 400x225 など
- ブロック形状: 6x6, 8x8 を中心に（EmbedCountが中間域になる組み合わせ）
- D1/D2: 36x20, 30x17, 25x14, 20x11 の4パターン

**期待される結果**:
- EmbedCount 5～15 の範囲での精度の詳細な変化を観察
- 99%以上の精度が安定して得られるEmbedCountの最小値を特定
- 画像の種類（風景、人物、テクスチャなど）による影響の有無を確認

## 今後の課題

- [ ] 実験2: 詳細な閾値の特定（複数画像、細かいパラメータ）
- [ ] 異なるJPEG品質（80, 90など）での評価
- [ ] ノイズ付加後の抽出精度評価
- [ ] 結果の統計分析とグラフ化
